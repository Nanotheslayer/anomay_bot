// –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –ö–û–î –î–õ–Ø WEB APP
const tg = window.Telegram?.WebApp;
let isTelegramWebApp = false;
let userId = null;
let isDemo = false;
let messages = [];
let debugLogs = [];

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message, data = null) {
const timestamp = new Date().toLocaleTimeString();
const logEntry = `[${timestamp}] ${message}`;

console.log(logEntry, data || '');
debugLogs.push({ time: timestamp, message, data });

// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥–∏
if (debugLogs.length > 50) {
debugLogs.shift();
}

updateDebugPanel();

// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
if (message.includes('‚ùå') || message.includes('–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø')) {
showNotification(message);
}
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
function sendDataToBot(data) {
log('üöÄ –ù–ê–ß–ò–ù–ê–Æ –î–ò–ê–ì–ù–û–°–¢–ò–ö–£ –û–¢–ü–†–ê–í–ö–ò');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Telegram –æ–±—ä–µ–∫—Ç
if (!window.Telegram) {
log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: window.Telegram –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
showNotification('‚ùå Telegram –æ–±—ä–µ–∫—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
return false;
}
log('‚úÖ window.Telegram –Ω–∞–π–¥–µ–Ω');

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: WebApp –æ–±—ä–µ–∫—Ç
if (!window.Telegram.WebApp) {
log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: window.Telegram.WebApp –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
showNotification('‚ùå WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
return false;
}
log('‚úÖ window.Telegram.WebApp –Ω–∞–π–¥–µ–Ω');

const tg = window.Telegram.WebApp;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ WebApp
const diagnostics = {
platform: tg.platform,
version: tg.version,
colorScheme: tg.colorScheme,
isExpanded: tg.isExpanded,
viewportHeight: tg.viewportHeight,
initDataExists: !!tg.initData,
initDataLength: tg.initData ? tg.initData.length : 0,
initDataPreview: tg.initData ? tg.initData.substring(0, 50) + '...' : '–ù–ï–¢',
sendDataType: typeof tg.sendData,
sendDataExists: typeof tg.sendData === 'function',
MainButtonExists: !!tg.MainButton,
themeParamsCount: Object.keys(tg.themeParams || {}).length,
webAppUser: tg.initDataUnsafe?.user ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'
};

log('üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM WEBAPP:', diagnostics);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –°–ú–Ø–ì–ß–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê - initData
if (!tg.initData) {
log('‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: tg.initData –û–¢–°–£–¢–°–¢–í–£–ï–¢!');
log('‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ Web App –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ KeyboardButton, –≥–¥–µ initData –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å');
log('üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏...');
// –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º false - –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
} else {
log('‚úÖ tg.initData –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: sendData —Ñ—É–Ω–∫—Ü–∏—è
if (typeof tg.sendData !== 'function') {
log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: tg.sendData –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π!');
log('‚ùå –¢–∏–ø tg.sendData:', typeof tg.sendData);
log('‚ùå –í—Å–µ –º–µ—Ç–æ–¥—ã tg:', Object.getOwnPropertyNames(tg));
showNotification('‚ùå sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
return false;
}
log('‚úÖ tg.sendData —è–≤–ª—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π');

try {
// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
const jsonData = JSON.stringify(data);
log('üìä –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', {
originalData: data,
jsonString: jsonData,
jsonLength: jsonData.length
});

if (jsonData.length > 4096) {
log('‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ!', jsonData.length);
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
showNotification('üì° –û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ... ' + jsonData.length + ' —Å–∏–º–≤–æ–ª–æ–≤');

// –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ú–û–ú–ï–ù–¢ - –æ—Ç–ø—Ä–∞–≤–∫–∞
log('üöÄ –í–´–ü–û–õ–ù–Ø–Æ tg.sendData()...');

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ü–ï–†–ï–î –æ—Ç–ø—Ä–∞–≤–∫–æ–π
let eventFired = false;

if (tg.onEvent) {
tg.onEvent('web_app_data_sent', function() {
log('‚úÖ –°–û–ë–´–¢–ò–ï: web_app_data_sent –ø–æ–ª—É—á–µ–Ω–æ!');
eventFired = true;
showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ–º)');
});
}

// –û–¢–ü–†–ê–í–õ–Ø–ï–ú
tg.sendData(jsonData);

log('‚úÖ tg.sendData() –≤—ã–ø–æ–ª–Ω–µ–Ω –ë–ï–ó –∏—Å–∫–ª—é—á–µ–Ω–∏–π!');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
setTimeout(() => {
log('‚è∞ 1 —Å–µ–∫: —Å–æ–±—ã—Ç–∏–µ fired =', eventFired);
if (!eventFired) {
showNotification('‚è≥ 1 —Å–µ–∫ - —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ, –Ω–æ –¥–∞–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è');
}
}, 1000);

setTimeout(() => {
log('‚è∞ 3 —Å–µ–∫: —Å–æ–±—ã—Ç–∏–µ fired =', eventFired);
if (!eventFired) {
showNotification('‚ö†Ô∏è 3 —Å–µ–∫ - —Å–æ–±—ã—Ç–∏–µ –ù–ï –ø–æ–ª—É—á–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç');
log('‚ùå –í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Telegram –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—Ç–ø—Ä–∞–≤–∫—É');
}
}, 3000);

setTimeout(() => {
log('‚è∞ 5 —Å–µ–∫: —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–±—ã—Ç–∏–µ fired =', eventFired);
if (!eventFired) {
showNotification('‚ùå 5 —Å–µ–∫ - —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ, –Ω–æ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π');
}
}, 5000);

return true;

} catch (error) {
log('‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –≤ sendDataToBot:', {
message: error.message,
stack: error.stack,
name: error.name
});
showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
return false;
}
}

// –°—É–ø–µ—Ä-—Ç–µ—Å—Ç
function testConnection() {
log('üß™ –ó–ê–ü–£–°–ö –°–£–ü–ï–†-–¢–ï–°–¢–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø');

const testData = {
type: 'test_connection',
user_id: userId,
timestamp: new Date().toISOString(),
test_message: 'üß™ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –¢–ï–°–¢ –û–¢ WEB APP',
webapp_info: {
url: window.location.href,
userAgent: navigator.userAgent.substring(0, 100),
timestamp: Date.now(),
telegram: {
version: tg?.version,
platform: tg?.platform,
initDataExists: !!tg?.initData,
sendDataExists: typeof tg?.sendData === 'function'
}
}
};

log('üß™ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:', testData);

const success = sendDataToBot(testData);

log('üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞:', success);

if (success) {
showNotification('üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ñ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –≤ –±–æ—Ç–µ...');
} else {
showNotification('‚ùå –¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è! –°–º. –∫–æ–Ω—Å–æ–ª—å');
}
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π
function initTelegramWebApp() {
log('üöÄ –ù–ê–ß–ò–ù–ê–Æ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Æ WEBAPP');

if (!tg) {
log('‚ùå Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
return false;
}

log('‚úÖ Telegram Web App –Ω–∞–π–¥–µ–Ω');

try {
// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
if (tg.onEvent) {
tg.onEvent('web_app_data_sent', () => {
log('üì° –°–û–ë–´–¢–ò–ï: web_app_data_sent');
showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
});

tg.onEvent('theme_changed', () => {
log('üé® –°–û–ë–´–¢–ò–ï: theme_changed');
});

tg.onEvent('viewport_changed', () => {
log('üì± –°–û–ë–´–¢–ò–ï: viewport_changed');
});
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
tg.ready();
log('‚úÖ tg.ready() –≤—ã–ø–æ–ª–Ω–µ–Ω');

tg.expand();
log('‚úÖ tg.expand() –≤—ã–ø–æ–ª–Ω–µ–Ω');

tg.disableVerticalSwipes?.();
log('‚úÖ tg.disableVerticalSwipes() –≤—ã–ø–æ–ª–Ω–µ–Ω');

// –ü–æ–ª—É—á–∞–µ–º user ID
if (tg.initDataUnsafe?.user?.id) {
userId = tg.initDataUnsafe.user.id.toString();
log('‚úÖ User ID –∏–∑ initDataUnsafe:', userId);
}

// –ò–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
const urlParams = new URLSearchParams(window.location.search);
const urlUserId = urlParams.get('user_id');
if (urlUserId) {
userId = urlUserId;
log('‚úÖ User ID –∏–∑ URL:', userId);
}

// –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
log('üìä –ò–¢–û–ì–û–í–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:', {
userId: userId,
initData: tg.initData ? '–ï–°–¢–¨' : '–ù–ï–¢!',
sendData: typeof tg.sendData === 'function' ? '–î–û–°–¢–£–ü–ï–ù' : '–ù–ï–¢!'
});

isTelegramWebApp = true;
return true;

} catch (error) {
log('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
return false;
}
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
function initializeApp() {
log('üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø');

// –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL
const urlParams = new URLSearchParams(window.location.search);
const urlUserId = urlParams.get('user_id');
if (urlUserId) {
userId = urlUserId;
log('‚úÖ User ID –∏–∑ URL:', userId);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
const telegramOk = initTelegramWebApp();

log('üîç –ü–†–û–í–ï–†–ö–ê –†–ï–ñ–ò–ú–ê:', {
telegramOk: telegramOk,
userId: userId,
hasTelegram: !!window.Telegram?.WebApp,
hasInitData: !!window.Telegram?.WebApp?.initData,
url: window.location.href
});

// –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –±–æ–ª–µ–µ –º—è–≥–∫–∏–µ —É—Å–ª–æ–≤–∏—è
if (userId && window.Telegram?.WebApp) {
// –ï—Å–ª–∏ –µ—Å—Ç—å userId –∏ Telegram WebApp –æ–±—ä–µ–∫—Ç - –ø—Ä–æ–±—É–µ–º —Ä–µ–∂–∏–º –±–æ—Ç–∞
isDemo = false;
log('‚úÖ –†–ï–ñ–ò–ú: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ë–û–¢–û–ú (–ø–æ userId + WebApp)');
updateStatusIndicator('–ë–û–¢', 'status-bot');

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ready —Å–∏–≥–Ω–∞–ª
setTimeout(() => {
sendReadySignal();
}, 1000);

} else if (window.Telegram?.WebApp) {
// –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ WebApp –Ω–æ –Ω–µ—Ç userId - –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ Telegram
const telegramUserId = window.Telegram.WebApp.initDataUnsafe?.user?.id;
if (telegramUserId) {
userId = telegramUserId.toString();
isDemo = false;
log('‚úÖ –†–ï–ñ–ò–ú: –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –ë–û–¢–û–ú (–ø–æ Telegram userId)');
updateStatusIndicator('–ë–û–¢', 'status-bot');

setTimeout(() => {
sendReadySignal();
}, 1000);
} else {
isDemo = true;
log('‚ö†Ô∏è –†–ï–ñ–ò–ú: –î–ï–ú–û (–Ω–µ—Ç userId)');
updateStatusIndicator('–î–ï–ú–û', 'status-demo');
showNotification('üì± –î–µ–º–æ —Ä–µ–∂–∏–º: –Ω–µ—Ç User ID');
}
} else {
isDemo = true;
log('‚ö†Ô∏è –†–ï–ñ–ò–ú: –î–ï–ú–û (–Ω–µ—Ç Telegram WebApp)');
updateStatusIndicator('–î–ï–ú–û', 'status-demo');
showNotification('üì± –î–µ–º–æ —Ä–µ–∂–∏–º: –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç');
}

loadInitialData();
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ ready —Å–∏–≥–Ω–∞–ª–∞
function sendReadySignal() {
const readyData = {
type: 'app_ready',
user_id: userId,
timestamp: new Date().toISOString(),
app_version: '2.0.0-debug'
};

log('üì° –û—Ç–ø—Ä–∞–≤–ª—è—é ready —Å–∏–≥–Ω–∞–ª:', readyData);
sendDataToBot(readyData);
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendMessage() {
const input = document.getElementById('messageInput');
const text = input.value.trim();

if (!text) {
showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
return;
}

log('üìù –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', text);

// –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const userMessage = {
id: Date.now().toString(),
sender: 'user',
text: text,
timestamp: new Date().toISOString()
};

addMessage(userMessage);
input.value = '';
autoResize(input);
showTypingIndicator();

try {
if (!isDemo) {
const messageData = {
type: 'send_message',
user_id: userId,
message: text,
timestamp: new Date().toISOString()
};

log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É:', messageData);
const success = sendDataToBot(messageData);

if (success) {
showNotification('üì° –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É!');

setTimeout(() => {
const statusMessage = {
id: (Date.now() + 1).toString(),
sender: 'assistant',
text: '‚è≥ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É. –û—Ç–≤–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ Telegram —á–∞—Ç–µ.',
timestamp: new Date().toISOString()
};
addMessage(statusMessage);
hideTypingIndicator();
}, 2000);

} else {
throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å');
}
} else {
// –î–µ–º–æ –æ—Ç–≤–µ—Ç
setTimeout(() => {
const demoMessage = {
id: (Date.now() + 1).toString(),
sender: 'assistant',
text: 'ü§ñ –î–µ–º–æ –æ—Ç–≤–µ—Ç. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç!',
timestamp: new Date().toISOString()
};
addMessage(demoMessage);
hideTypingIndicator();
}, 1500);
}

} catch (error) {
log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
hideTypingIndicator();

const errorMessage = {
id: (Date.now() + 1).toString(),
sender: 'assistant',
text: 'üòî –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.',
timestamp: new Date().toISOString()
};
addMessage(errorMessage);
showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
}
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function updateStatusIndicator(text, className) {
const indicator = document.getElementById('statusIndicator');
indicator.textContent = text;
indicator.className = `status-indicator ${className}`;
}

function loadInitialData() {
if (isDemo) {
const welcomeMessage = {
id: 'welcome',
sender: 'assistant',
text: 'üëã –î–µ–º–æ —Ä–µ–∂–∏–º. –î–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç!',
timestamp: new Date().toISOString()
};
addMessage(welcomeMessage);
}
}

function addMessage(message) {
messages.push(message);
renderMessages();
}

function renderMessages() {
const container = document.getElementById('messagesContainer');

if (messages.length === 0) {
container.innerHTML = `
<div class="empty-state">
    <div class="empty-icon">üí¨</div>
    <div class="empty-title">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ</div>
    <div class="empty-description">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Gemini AI</div>
</div>
`;
return;
}

container.innerHTML = '';
messages.forEach(message => {
const messageElement = createMessageElement(message);
container.appendChild(messageElement);
});
container.scrollTop = container.scrollHeight;
}

function createMessageElement(message) {
const messageDiv = document.createElement('div');
messageDiv.className = `message ${message.sender}`;

const avatar = message.sender === 'user' ? 'üë§' : 'ü§ñ';
const time = formatTime(message.timestamp);

messageDiv.innerHTML = `
<div class="message-avatar">${avatar}</div>
<div class="message-content">
    <div class="message-text">${message.text}</div>
    <div class="message-time">${time}</div>
</div>
`;

return messageDiv;
}

function showTypingIndicator() {
const container = document.getElementById('messagesContainer');
const existing = document.getElementById('typingIndicator');
if (existing) existing.remove();

const indicator = document.createElement('div');
indicator.className = 'message assistant';
indicator.id = 'typingIndicator';
indicator.innerHTML = `
<div class="message-avatar">ü§ñ</div>
<div class="typing-indicator">
    <span>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...</span>
    <div class="typing-dots">
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
    </div>
</div>
`;

container.appendChild(indicator);
container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
const indicator = document.getElementById('typingIndicator');
if (indicator) indicator.remove();
}

function showNotification(message) {
document.querySelectorAll('.notification').forEach(notif => notif.remove());

const notification = document.createElement('div');
notification.className = 'notification';
notification.textContent = message;
document.body.appendChild(notification);

setTimeout(() => {
if (notification.parentNode) {
notification.remove();
}
}, 4000);
}

function showDebugInfo() {
const debugInfo = {
isTelegramWebApp,
userId,
isDemo,
messagesCount: messages.length,
telegramVersion: tg?.version || 'N/A',
platform: tg?.platform || 'N/A',
initData: tg?.initData ? '–ï–°–¢–¨' : '–ù–ï–¢',
sendDataAvailable: typeof tg?.sendData === 'function'
};

log('üîç Debug Info:', debugInfo);
alert('Debug:\n' + JSON.stringify(debugInfo, null, 2));
}

function updateDebugPanel() {
const panel = document.getElementById('debugPanel');
const recentLogs = debugLogs.slice(-8);

panel.innerHTML = recentLogs.map(log =>
`${log.time}: ${log.message}`
).join('<br>');
}

function formatTime(isoString) {
const date = new Date(isoString);
return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
}

function autoResize(textarea) {
textarea.style.height = 'auto';
textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
}

function handleKeyPress(event) {
if (event.key === 'Enter' && !event.shiftKey) {
event.preventDefault();
sendMessage();
}
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
log('üìã DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
initializeApp();

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º debug –ø–∞–Ω–µ–ª—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
setTimeout(() => {
document.getElementById('debugPanel').style.display = 'block';
}, 2000);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Telegram
if (tg) {
tg.onEvent?.('web_app_data_sent', function() {
log('‚úÖ –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–ë–´–¢–ò–ï: web_app_data_sent');
showNotification('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)');
});
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(event) {
log('‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
});

window.addEventListener('unhandledrejection', function(event) {
log('‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–∏—Å–∞:', event.reason);
});

log('üöÄ Web App —Å–∫—Ä–∏–ø—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω');